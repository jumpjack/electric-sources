<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

  <head>

  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="generator" content="PSPad editor, www.pspad.com">

  <title>Visualizzatore consumi enel</title>

  </head>

  <script src="Chart.bundle.js"></script>

  <body>

<h1>Visualizzatore consumi orari ENEL Energia</h1>

<br>

Incolla qui l'output del tuo link (*):<br>

<textarea id="inputData" name="inputData" cols = 100 rows = 5></textarea><br>

<button onclick="elabora()">Elabora</button><br>

Giorno: <input type="text" id="giorno" name="giorno" value = "1"><br>

Mese: <input type="text" id="mese" name="mese" value = "1"><br>

Anno: <input type="text" id="anno" name="anno" value = "2022"><br>

Euro/kWh: <input type="text" id="euk" name="euk" value = "0.30"><br>

<br>



Grafico: <button onclick="aggiorna()">Aggiorna</button><br>

<canvas id="myChart" width="400" height="400"></canvas>

<br>

Minimo: <span id="spn_minimo" name="spn_minimo"></span><br>



Medio: <input type="text" id="spn_medio" name="spn_medio"></span> -

Euro stimati (Giorno/Mese/Anno) <span id="spn_costoGmed" name="spn_costoGmed"></span>/

<span id="spn_costoMmed" name="spn_costoMmed"></span>

/<span id="spn_costoAmed" name="spn_costoAmed"></span>

<button onclick="ricalcola()">Ricalcola</button><br>

Massimo:<span id="spn_massimo" name="spn_massimo"></span><br>





Totale: <span id="spn_totale" name="spn_totale"></span> -

G: <span id="spn_costoGtot" name="spn_costoGtot"></span>,

M: <span id="spn_costoMtot" name="spn_costoMtot"></span>,

A: <span id="spn_costoAtot" name="spn_costoAtot"></span><br>





<br>

Output da incollare in spreadsheet:<br>

<textarea id="outputData" name="outputData" cols = 100 rows = 5></textarea><br>

<br>

(*)

Il link risulta attivo solo dopo che hai effettuato l'accesso alla tua area clienti sul sito <a href="https://www.enel.it/bin/areaclienti/">ENEL energia</a>.<br>

<br>

Link di esempio:<br>

https://www.enel.it/bin/areaclienti/auth/aggregateConsumption?pod=CODICE_POD&userNumber=NUMERO_UTENZA&validityFrom=INIZIO(GGMMAAAA)&validityTo=FINE(GGMMAAAA)&_=TIMESTAMP<br>

<br>

Crea il tuo link usando il tuo codice POD e numero utente (li trovi sulla bolletta):<br>

Codice POD:<input type="text" id="POD" name="POD"><br>

Utenza:<input type="text" id="utente" name="utente"><br>

Data inizio (GGMMAAAA):<input type="text" id="inizio" name="inizio" value = "01012022"><br>

Data fine (GGMMAAAA):<input type="text" id="fine" name="fine" value = "13092022"><br>

<button onclick="creaLink()">Crea</button><br>

Link: <span id = "mylink" name="mylink"></span><br>

<script>

const myLabels = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];



myConfig = {

    type: 'bar',

    data: {

        labels: myLabels, // Etichette asse X

        datasets: [{

            label: 'Consumi giornalieri',

            data: [], // Dati (asse Y)

            borderWidth: 1

        }]

    },

    options: {

        scales: {

            y: {

                beginAtZero: true

            }

        },

        responsive: false

    }

}





const ctx = document.getElementById('myChart').getContext('2d');





function elabora() {

  data = inputData.value;

  JSONdata = JSON.parse(data);

  hourData = JSONdata.data.aggregationResult.aggregations[0].results;

  hourData.forEach( (datum) => {

      hourValues = datum.binValues;

      hourDate = datum.date;

      dateSplit = hourDate.substr(0,2) + "/" + hourDate.substr(2,2) + "/" + hourDate.substr(4,4)

      hourValues.forEach((subdatum) => {

      outputData.value += dateSplit + " " + ((subdatum.name.substr(1,2)*1)-1) + ":00\t" + (subdatum.value+"").replace(".",",") + "\n";

  });

});



daysData = JSONdata.data.aggregationResult.aggregations[0].results;

console.log(JSONdata.data.aggregationResult.aggregations[0].referenceID, JSONdata.data.aggregationResult.aggregations[0].results);

console.log(JSONdata.data.aggregationResult.aggregations[1].referenceID, JSONdata.data.aggregationResult.aggregations[1].results);

myChart = new Chart(ctx, myConfig)



}



function creaLink() {

  d = new Date()

  timestamp = d.getTime();

  console.log(timestamp);

  base = "https://www.enel.it/bin/areaclienti/auth/aggregateConsumption?pod=";

  parte2 = "&userNumber=";

  parte3 = "&validityFrom=";

  parte4 = "&validityTo="

  finale = "&_=" + timestamp;

  url = base + POD.value + parte2 + utente.value + parte3 + inizio.value + parte4 + fine.value + finale;

  console.log(url);

  mylink.innerHTML = '<a href="' + url + '">click</a>';

}



function convertiDataRichiesta(d) {

  for(var i = 0; i < daysData.length; i++) {

    if (daysData[i].date == d) return i;

  }

  return -1;

}



function aggiorna() {

  dataUtente = zeri(giorno.value)  + zeri(mese.value) +  zeri(anno.value);

  numeroPerData = convertiDataRichiesta(dataUtente);

  if (numeroPerData < 0) {

    alert("Giorno non disponibile: ", dataUtente);

    return -2;

  }

  dayDataRaw = daysData[numeroPerData];

  dayDate = dayDataRaw.date;

  dayValues = [];

  minimo = 10000;

  massimo = -1;

  medio = 0;

  totale = 0;

  conteggio = 0;

  dayDataRaw.binValues.forEach((objVal) => {

    dayValues.push(objVal.value);

    conteggio++;

    totale += objVal.value;

    if (objVal.value > massimo) massimo = objVal.value;

    if (objVal.value < minimo) minimo = objVal.value;



  });

  medio = totale/conteggio;

  calcolaCosti(medio, totale);

  dayValues.push(0); // debug

  dayValues.push(3.5); // debug

  myConfig.data.datasets[0].data = dayValues;

  myChart.update();



  spn_minimo.innerHTML = minimo.toFixed(2);

  spn_medio.value = medio.toFixed(2);

  spn_massimo.innerHTML = massimo.toFixed(2);

  spn_totale.innerHTML = totale.toFixed(2);

  spn_costoGmed.innerHTML = costoG_daMedio.toFixed(2);

  spn_costoGtot.innerHTML = costoG_daTotale.toFixed(2);



  spn_costoMmed.innerHTML = costoM_daMedio.toFixed(2);

  spn_costoMtot.innerHTML = costoM_daTotale.toFixed(2);



  spn_costoAmed.innerHTML = costoA_daMedio.toFixed(2);

  spn_costoAtot.innerHTML = costoA_daTotale.toFixed(2);



}



function calcolaCosti(medio, totale) {

  costoG_daMedio = medio * 24 * euk.value;

  costoG_daTotale = totale * euk.value;



  costoM_daMedio = costoG_daMedio*30;

  costoM_daTotale = costoG_daTotale*30;



  costoA_daMedio = costoG_daMedio*365;

  costoA_daTotale = costoG_daTotale*365;



console.log(costoG_daMedio, costoG_daTotale, costoM_daMedio);

}



function ricalcola() {

  calcolaCosti(spn_medio.value, totale);

  spn_costoGmed.innerHTML = costoG_daMedio.toFixed(2);

  spn_costoGtot.innerHTML = costoG_daTotale.toFixed(2);



  spn_costoMmed.innerHTML = costoM_daMedio.toFixed(2);

  spn_costoMtot.innerHTML = costoM_daTotale.toFixed(2);



  spn_costoAmed.innerHTML = costoA_daMedio.toFixed(2);

  spn_costoAtot.innerHTML = costoA_daTotale.toFixed(2);

}



function zeri(v) {

  if (v<10) {return "0"+v} else return v;

}

</script>



  </body>

</html>
